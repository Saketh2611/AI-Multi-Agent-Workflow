<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Multi-Agent Workflow Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Configure Tailwind CSS
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'neon-blue': '#00D4FF',
            'neon-purple': '#8B5CF6',
            'dark-bg': '#0F0F23',
            'dark-card': '#1A1A2E',
            'dark-sidebar': '#16213E'
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    body { font-family: 'Inter', sans-serif; }

    .glow-blue { box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
    .glow-purple { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
    
    .message-slide-in { animation: slideInLeft 0.5s ease-out; }
    .progress-glow { animation: pulseGlow 2s infinite; }
    .agent-active { border-color: #00D4FF; box-shadow: 0 0 15px rgba(0, 212, 255, 0.2); }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(0, 212, 255, 0.5); }
      50% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.8); }
    }

    .code-block { background: #1e1e2e; border: 1px solid #3a3a5e; }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #16213E; }
    ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
  </style>
</head>

<body class="bg-dark-bg text-white min-h-screen overflow-hidden">
  
  <nav class="fixed top-0 left-0 right-0 bg-dark-card border-b border-gray-700 z-50 px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 bg-gradient-to-r from-neon-blue to-neon-purple rounded-lg flex items-center justify-center">
          <span class="text-white font-bold text-sm">AI</span>
        </div>
        <h1 class="text-xl font-semibold text-white">AI Multi-Agent Workflow</h1>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-3 h-3 rounded-full bg-red-500" id="connectionStatus"></div>
        <span class="text-xs text-gray-400" id="connectionText">Disconnected</span>
      </div>
    </div>
  </nav>

  <div class="pt-20 flex h-screen">
    
    <div class="w-80 bg-dark-sidebar border-r border-gray-700 flex flex-col z-10">
      <div class="p-4 border-b border-gray-700">
        <h2 class="text-lg font-semibold text-neon-blue">Live Logs</h2>
        <p class="text-gray-400 text-sm">Agent interactions</p>
      </div>
      <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chatContainer">
        </div>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden relative">
      
      <div class="bg-dark-card border-b border-gray-700 p-6">
        <div class="flex items-center justify-between relative max-w-4xl mx-auto">
          <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-gray-600 -translate-y-1/2 z-0"></div>
          <div class="absolute top-1/2 left-0 h-0.5 bg-gradient-to-r from-neon-blue to-neon-purple transition-all duration-1000 -translate-y-1/2 z-0" id="progressLine" style="width: 0%"></div>

          <div class="flex items-center justify-between w-full relative z-10">
            <div class="flex flex-col items-center" id="stage-planner">
              <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center mb-2 transition-all duration-500 circle-bg">
                <span class="text-white font-semibold text-sm">1</span>
              </div>
              <span class="text-xs font-medium text-gray-400">Planner</span>
            </div>

            <div class="flex flex-col items-center" id="stage-researcher">
              <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center mb-2 transition-all duration-500 circle-bg">
                <span class="text-white font-semibold text-sm">2</span>
              </div>
              <span class="text-xs font-medium text-gray-400">Research</span>
            </div>

            <div class="flex flex-col items-center" id="stage-coder">
              <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center mb-2 transition-all duration-500 circle-bg">
                <span class="text-white font-semibold text-sm">3</span>
              </div>
              <span class="text-xs font-medium text-gray-400">Coding</span>
            </div>

            <div class="flex flex-col items-center" id="stage-reporter">
              <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center mb-2 transition-all duration-500 circle-bg">
                <span class="text-white font-semibold text-sm">4</span>
              </div>
              <span class="text-xs font-medium text-gray-400">Report</span>
            </div>
          </div>
        </div>
      </div>

      <div class="flex-1 p-6 overflow-y-auto pb-32 space-y-6"> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          <div class="lg:col-span-2 bg-dark-card rounded-lg p-1 border border-gray-700 flex flex-col h-96">
             <div class="bg-gray-800 px-4 py-2 rounded-t-lg flex justify-between items-center">
                <span class="text-sm text-gray-300 font-mono">solution.py</span>
                <div class="flex space-x-2">
                   <div class="w-3 h-3 rounded-full bg-red-500"></div>
                   <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                   <div class="w-3 h-3 rounded-full bg-green-500"></div>
                </div>
             </div>
            <div class="code-block flex-1 p-4 overflow-auto font-mono text-sm text-neon-blue" id="codeContainer">
              <div class="text-gray-500 text-center h-full flex items-center justify-center italic">
                Waiting for code generation...
              </div>
            </div>
          </div>

          <div class="bg-dark-card rounded-lg p-6 border border-gray-700 flex flex-col justify-between h-96">
            <div>
                <h4 class="text-lg font-semibold mb-4 text-white">Results</h4>
                <div class="space-y-4" id="metricsContainer">
                    <div class="bg-gray-800/50 p-3 rounded flex justify-between items-center">
                        <span class="text-gray-400 text-sm">Status</span>
                        <span class="text-yellow-400 font-mono">Pending</span>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded flex justify-between items-center">
                        <span class="text-gray-400 text-sm">Accuracy</span>
                        <span class="text-gray-500 font-mono">--</span>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded flex justify-between items-center">
                        <span class="text-gray-400 text-sm">Time</span>
                        <span class="text-gray-500 font-mono">--</span>
                    </div>
                </div>
            </div>
            <button id="downloadBtn" disabled class="w-full bg-gray-700 text-gray-400 cursor-not-allowed px-4 py-3 rounded-lg font-medium transition-all mt-4">
                Download Report
            </button>
          </div>
        </div>

        <div>
          <h2 class="text-xl font-bold mb-4 text-neon-blue">Agent Status</h2>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            
            <div id="card-planner" class="bg-dark-card p-4 rounded-xl border border-gray-700 transition-all duration-300">
              <div class="flex items-center justify-between mb-2">
                  <h3 class="font-semibold text-white">Planner</h3>
                  <div class="w-2 h-2 rounded-full bg-gray-500 status-dot"></div>
              </div>
              <p class="text-xs text-gray-400 status-text">Waiting...</p>
            </div>

            <div id="card-researcher" class="bg-dark-card p-4 rounded-xl border border-gray-700 transition-all duration-300">
              <div class="flex items-center justify-between mb-2">
                  <h3 class="font-semibold text-white">Researcher</h3>
                  <div class="w-2 h-2 rounded-full bg-gray-500 status-dot"></div>
              </div>
              <p class="text-xs text-gray-400 status-text">Waiting...</p>
            </div>

            <div id="card-coder" class="bg-dark-card p-4 rounded-xl border border-gray-700 transition-all duration-300">
              <div class="flex items-center justify-between mb-2">
                  <h3 class="font-semibold text-white">Coder</h3>
                  <div class="w-2 h-2 rounded-full bg-gray-500 status-dot"></div>
              </div>
              <p class="text-xs text-gray-400 status-text">Waiting...</p>
            </div>

            <div id="card-reporter" class="bg-dark-card p-4 rounded-xl border border-gray-700 transition-all duration-300">
              <div class="flex items-center justify-between mb-2">
                  <h3 class="font-semibold text-white">Reporter</h3>
                  <div class="w-2 h-2 rounded-full bg-gray-500 status-dot"></div>
              </div>
              <p class="text-xs text-gray-400 status-text">Waiting...</p>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="fixed bottom-0 left-80 right-0 bg-dark-card border-t border-gray-700 p-4 z-50">
    <div class="flex space-x-4 max-w-5xl mx-auto items-center">
      
      <label class="cursor-pointer bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-lg border border-gray-600 transition-colors flex items-center justify-center h-[50px] w-[50px]">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
        <input type="file" id="pdfInput" class="hidden" accept=".pdf" />
      </label>

      <input id="taskInput" type="text" 
        placeholder="Enter a task (e.g., 'Analyze the PDF and write a python summary script')" 
        class="flex-1 bg-gray-900 text-white rounded-lg px-4 py-3 border border-gray-600 focus:outline-none focus:border-neon-blue transition-colors h-[50px]">
      
      <button id="startBtn" disabled 
        class="bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition-all whitespace-nowrap h-[50px] flex items-center justify-center">
        Connecting...
      </button>
    </div>
  </div>

  <script>
    const taskInput = document.getElementById('taskInput');
    const startBtn = document.getElementById('startBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const connectionText = document.getElementById('connectionText');
    const pdfInput = document.getElementById('pdfInput'); // Added ref
    
    let socket;

    function connect() {
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      socket = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

      socket.onopen = () => {
        console.log("Connected");
        connectionStatus.className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)]";
        connectionText.textContent = "Connected";
        startBtn.disabled = false;
        startBtn.textContent = "Start Workflow";
        startBtn.className = "bg-gradient-to-r from-neon-blue to-neon-purple px-8 py-3 rounded-lg font-semibold hover:glow-blue transition-all text-white whitespace-nowrap h-[50px]";
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        switch (data.type) {
          case 'chat':
            addChatMessage(data.agent, data.message);
            break;
          case 'progress':
            updateProgress(data.stage); 
            break;
          case 'code':
            updateCode(data.code);
            break;
          case 'metrics':
            updateMetrics(data);
            break;
          case 'report_data':
            triggerDownload(data.content, data.filename);
            break;
          case 'error':
            addChatMessage('System', `Error: ${data.message}`, 'red');
            break;
        }
      };

      socket.onclose = () => {
        console.log("Disconnected");
        connectionStatus.className = "w-3 h-3 rounded-full bg-red-500";
        connectionText.textContent = "Disconnected";
        startBtn.disabled = true;
        startBtn.textContent = "Reconnecting...";
        startBtn.className = "bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition-all whitespace-nowrap h-[50px] flex items-center justify-center";
        setTimeout(connect, 3000);
      };
    }

    // --- PDF Upload Logic (ADDED) ---
    pdfInput.addEventListener("change", async () => {
      const file = pdfInput.files[0];
      if (!file) return;

      addChatMessage("User", `ðŸ“„ Uploaded PDF: ${file.name}`);

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch("/upload_pdf", { method: "POST", body: formData });
        const data = await res.json();

        if (data.error) {
          addChatMessage("System", `âŒ PDF Upload Failed: ${data.error}`);
        } else {
          addChatMessage("System", `âœ… PDF processed successfully. Chunks stored: ${data.chunks}`);
        }
      } catch (err) {
        addChatMessage("System", `âŒ PDF Upload Error: ${err.message}`);
      }
    });


    // --- Logic ---

    startBtn.addEventListener('click', sendMessage);
    taskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    function sendMessage() {
        const task = taskInput.value.trim();
        if (!task || startBtn.disabled) return;
        
        resetUI();
        addChatMessage('User', task, 'green');
        // Sending as JSON object to be safe/extensible
        socket.send(JSON.stringify({ type: "start", task: task })); 
        taskInput.value = '';
    }

    downloadBtn.addEventListener('click', () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: 'get_report' }));
        }
    });

    // --- UI Updaters ---

    function updateProgress(stageNum) {
        const stages = ['planner', 'researcher', 'coder', 'reporter'];
        const activeIndex = stageNum - 1; 
        const progressLine = document.getElementById('progressLine');
        
        const width = (activeIndex / (stages.length - 1)) * 100;
        progressLine.style.width = `${width}%`;

        stages.forEach((stage, idx) => {
            const el = document.getElementById(`stage-${stage}`);
            const circle = el.querySelector('.circle-bg');
            const text = el.querySelector('span');

            if (idx <= activeIndex) {
                circle.className = "w-10 h-10 rounded-full bg-neon-blue glow-blue flex items-center justify-center mb-2 transition-all duration-500 circle-bg";
                text.className = "text-black font-bold text-sm";
                if (idx === activeIndex) {
                    circle.classList.add('progress-glow');
                } else {
                    circle.classList.remove('progress-glow');
                }
            } else {
                circle.className = "w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center mb-2 transition-all duration-500 circle-bg";
                text.className = "text-white font-semibold text-sm";
                circle.classList.remove('progress-glow');
            }
        });

        stages.forEach((stage, idx) => {
            const card = document.getElementById(`card-${stage}`);
            const dot = card.querySelector('.status-dot');
            const txt = card.querySelector('.status-text');

            card.classList.remove('agent-active', 'border-neon-blue', 'border-green-500', 'border-gray-700');
            dot.classList.remove('bg-gray-500', 'bg-yellow-400', 'bg-green-500');

            if (idx === activeIndex) {
                card.classList.add('agent-active', 'border-neon-blue');
                dot.classList.add('bg-yellow-400', 'animate-ping');
                txt.textContent = "Working...";
                txt.className = "text-xs text-yellow-400 status-text";
            } else if (idx < activeIndex) {
                card.classList.add('border-green-500'); 
                dot.classList.add('bg-green-500');
                dot.classList.remove('animate-ping');
                txt.textContent = "Completed";
                txt.className = "text-xs text-green-400 status-text";
            } else {
                card.classList.add('border-gray-700');
                dot.classList.add('bg-gray-500');
                dot.classList.remove('animate-ping');
                txt.textContent = "Idle";
                txt.className = "text-xs text-gray-400 status-text";
            }
        });
    }

    function updateCode(code) {
        const container = document.getElementById('codeContainer');
        container.innerHTML = `<pre><code>${escapeHtml(code)}</code></pre>`;
    }

    function updateMetrics(data) {
        const container = document.getElementById('metricsContainer');
        const statusColor = (data.systemStatus || '').toLowerCase() === 'complete' ? 'text-green-400' : 'text-yellow-400';
        
        container.innerHTML = `
            <div class="bg-gray-800/50 p-3 rounded flex justify-between items-center">
                <span class="text-gray-400 text-sm">Status</span>
                <span class="${statusColor} font-mono font-bold">${data.systemStatus}</span>
            </div>
            <div class="bg-gray-800/50 p-3 rounded flex justify-between items-center">
                <span class="text-gray-400 text-sm">Accuracy</span>
                <span class="text-neon-blue font-mono">${data.accuracy}</span>
            </div>
            <div class="bg-gray-800/50 p-3 rounded flex justify-between items-center">
                <span class="text-gray-400 text-sm">Time</span>
                <span class="text-neon-purple font-mono">${data.processingTime}</span>
            </div>
        `;
        
        if(data.systemStatus === 'Complete') {
            downloadBtn.disabled = false;
            downloadBtn.className = "w-full bg-gradient-to-r from-neon-blue to-neon-purple text-white hover:glow-blue px-4 py-3 rounded-lg font-medium transition-all mt-4";
        }
    }

    function addChatMessage(agent, msg, colorOverride=null) {
        const container = document.getElementById('chatContainer');
        const div = document.createElement('div');
        div.className = 'message-slide-in bg-gray-800 p-3 rounded-lg border border-gray-700';
        
        let avatarColor = 'bg-gray-500';
        if (agent === 'User') avatarColor = 'bg-green-500';
        if (agent === 'Planner') avatarColor = 'bg-yellow-500';
        if (agent === 'Researcher') avatarColor = 'bg-blue-500';
        if (agent === 'Coder') avatarColor = 'bg-purple-500';
        if (agent === 'Reporter') avatarColor = 'bg-teal-500';

        let formatted = escapeHtml(msg).replace(/```python([\s\S]*?)```/g, '<div class="bg-black/30 p-2 rounded mt-2 text-xs font-mono text-gray-300">$1</div>');

        div.innerHTML = `
            <div class="flex items-center space-x-2 mb-1">
                <div class="w-5 h-5 rounded-full ${avatarColor} flex items-center justify-center text-[10px] font-bold text-white">
                    ${agent[0]}
                </div>
                <span class="text-xs font-bold text-gray-300">${agent}</span>
                <span class="text-[10px] text-gray-500 ml-auto">${new Date().toLocaleTimeString()}</span>
            </div>
            <div class="text-sm text-gray-200 pl-7">${formatted}</div>
        `;
        
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function resetUI() {
        document.getElementById('chatContainer').innerHTML = '';
        document.getElementById('codeContainer').innerHTML = '<div class="text-gray-500 text-center h-full flex items-center justify-center italic">Waiting for code generation...</div>';
        updateProgress(0);
        downloadBtn.disabled = true;
        downloadBtn.className = "w-full bg-gray-700 text-gray-400 cursor-not-allowed px-4 py-3 rounded-lg font-medium transition-all mt-4";
        updateMetrics({systemStatus: 'Pending', accuracy: '--', processingTime: '--'});
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function triggerDownload(content, filename) {
        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    connect();
  </script>
</body>
</html>